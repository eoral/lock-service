# About
- This is an extensible lock service.
- Default implementation uses file system to persist locks.
- It can be extended to use other persistence layers such as an S3 bucket or a database.
- It is a Maven web application.

# Before running the application
- Go to `src/main/resources/application.properties`.
  - Change `lockFileDirectory` property according to your environment.
  - Generate a random hex string of length 64 and set it to `jwtSecretKey` property. You can use online tools such as https://www.browserling.com/tools/random-hex
- You are ready to run the application.

# How to acquire a lock
- Assume that you want to acquire the lock named `test-lock`.
- Make a POST request to `http://localhost:8180/api/pre-acquire-lock` as below.
```
curl -X POST 'http://localhost:8180/api/pre-acquire-lock' \
  -H 'Content-Type: application/json' \
  -d '{"lockName":"test-lock"}'
```
- Application will return a response as below. Copy the token, you will use it in the next request.
```
{
  "token": "eyJhbGciOiJIUzUxMiJ9.eyJyZXF1ZXN0SWQiOiJlNTZjMDZlYi00OTAwLTRkODUtYjdlYy0wZmUxYjU0MTAwMDciLCJsb2NrTmFtZSI6InRlc3QtbG9jayIsImNyZWF0aW9uVGltZSI6IjIwMjQtMTItMjZUMTE6NTg6NTIuNzM2NTYxNDAwWiJ9.bOhBwil8IDCXo5L3yfQSJ50N8_27K6VHChYI5OMPtq_bnS69Fp9E0kFTsvPjC3jfmn7f5GKEjqQ80JMHX66Rdg"
}
```
- Make a POST request to `http://localhost:8180/api/acquire-lock` as below.
```
curl -X POST 'http://localhost:8180/api/acquire-lock' \
  -H 'Content-Type: application/json' \
  -d '{"token":"eyJhbGciOiJIUzUxMiJ9.eyJyZXF1ZXN0SWQiOiJlNTZjMDZlYi00OTAwLTRkODUtYjdlYy0wZmUxYjU0MTAwMDciLCJsb2NrTmFtZSI6InRlc3QtbG9jayIsImNyZWF0aW9uVGltZSI6IjIwMjQtMTItMjZUMTE6NTg6NTIuNzM2NTYxNDAwWiJ9.bOhBwil8IDCXo5L3yfQSJ50N8_27K6VHChYI5OMPtq_bnS69Fp9E0kFTsvPjC3jfmn7f5GKEjqQ80JMHX66Rdg"}'
```
- If you get HTTP 200, it means that you have acquired the lock successfully. This lock won't be available to other processes until you release it.
- If you get HTTP 409, it means that the lock was acquired by another process, and it is not available.

# How to release a lock
- Assume that you have finished your work, and you want to release the lock.
- Make a POST request to `http://localhost:8180/api/release-lock` as below. You should use the same token that you used when acquiring the lock.
```
curl -X POST 'http://localhost:8180/api/release-lock' \
-H 'Content-Type: application/json' \
-d '{"token":"eyJhbGciOiJIUzUxMiJ9.eyJyZXF1ZXN0SWQiOiJlNTZjMDZlYi00OTAwLTRkODUtYjdlYy0wZmUxYjU0MTAwMDciLCJsb2NrTmFtZSI6InRlc3QtbG9jayIsImNyZWF0aW9uVGltZSI6IjIwMjQtMTItMjZUMTE6NTg6NTIuNzM2NTYxNDAwWiJ9.bOhBwil8IDCXo5L3yfQSJ50N8_27K6VHChYI5OMPtq_bnS69Fp9E0kFTsvPjC3jfmn7f5GKEjqQ80JMHX66Rdg"}'
```
- If you get HTTP 200, it means that you have released the lock successfully. This lock will be available to all processes.
- If you get HTTP 403, it means that you are trying to release a lock that was acquired by another process.

# Why do we need pre-acquire-lock step?
- Assume that we don't have pre-acquire-lock step in the application, and we are returning the token at acquire-lock step.
- You have a client application, and it sent a POST request to `http://localhost:8180/api/acquire-lock`.
- Lock was persisted and application returned HTTP 200.
- Before processing the application response, your client application went down for some reason.
- After some time, your client application started again, and it tried to acquire the same lock.
- The lock cannot be acquired by any process because it is already in acquired state.
- The lock cannot be released because your client application went down before it had a chance to save the token.
- The token is lost, the lock is stuck and nobody can release it. So, what is the solution?
- At pre-acquire-lock step, token is generated but lock is not persisted yet.
- When you get the token, save it in your client application's log at least.
- If the lock is stuck as described above, find the token from the log and release the lock manually.
- This recovery process can also be automated, it doesn't have to be manual.

# Token security
- Tokens generated by the application are JWTs.
- They cannot be generated or manipulated outside the application.
- If an invalid token is sent to the application, application will return HTTP 400.

# Notes
- If you want to run multiple instances of this application on different servers, using file system as the persistence layer may not be a good idea. You need to use a file system like Amazon Elastic File System (EFS) that can be mounted on multiple servers.
- This application is not used on production yet. Initially, it was created to express ideas.
